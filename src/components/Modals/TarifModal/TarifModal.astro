---
import Icon from "@components/Icons/Icon.astro";
import type { IconProps } from "@components/Icons/icon";
import { replaceScopedClasses } from "@lib/htmlUtils";
import type { TarifModalProps } from "@app-types/tarifs";
import styles from "./tarifModal.module.scss";
import tarifModalClientScript from "./tarifModal.client.js?url";

const {
  id,
  fallbackTitle,
  fallbackContent,
  defaultPlan,
  initialContent,
  defaultIcon = null,
  defaultBadge = null,
} = Astro.props as TarifModalProps & { defaultIcon?: IconProps["type"] | null };

const processedFallbackContent =
  replaceScopedClasses(fallbackContent, styles) ?? "";
const processedInitialContent =
  replaceScopedClasses(initialContent, styles) ?? "";

const trimmedInitialContent = processedInitialContent.trim()
  ? processedInitialContent
  : "";

const encodedInitialPlanContent = trimmedInitialContent
  ? encodeURIComponent(trimmedInitialContent)
  : "";

const iconEmpty = !defaultIcon && !defaultBadge;
---

<div
  id={id}
  class={styles.modalBackdrop}
  data-tarif-modal-root
  data-open="false"
  aria-hidden="true"
  data-default-plan={defaultPlan}
  data-default-badge={defaultBadge ?? ""}
  data-fallback-title={fallbackTitle}
  data-fallback-content={processedFallbackContent}
  data-initial-plan-content={encodedInitialPlanContent}
>
  <div
    class={styles.modal}
    role="dialog"
    aria-modal="true"
    aria-labelledby={`${id}-title`}
    aria-describedby={`${id}-body`}
  >
    <button
      type="button"
      class={styles.modalClose}
      data-modal-close
      aria-label="Fermer la fenêtre d'information"
    >
      ×
    </button>

    <header class={styles.modalHeader}>
      <div class={styles.modalIconGroup}>
        <div
          class={styles.modalIcon}
          data-modal-icon
          data-plan={defaultPlan}
          data-empty={iconEmpty ? "true" : undefined}
          aria-hidden={defaultIcon ? "true" : undefined}
        >
          {
            defaultIcon ? (
              <Icon type={defaultIcon} size={72} aria-hidden="true" />
            ) : defaultBadge ? (
              <span>{defaultBadge}</span>
            ) : (
              <span>{fallbackTitle}</span>
            )
          }
        </div>
      </div>

      <h3 id={`${id}-title`} class={styles.srOnly} data-modal-title>
        {fallbackTitle}
      </h3>
    </header>

    <div class={styles.modalBody}>
      <div
        class={styles.modalCommon}
        data-modal-common
        data-has-content={processedFallbackContent ? "true" : undefined}
      >
        {
          processedFallbackContent && (
            <Fragment set:html={processedFallbackContent} />
          )
        }
      </div>

      <div class={styles.modalPlanContent} data-modal-body>
        {
          trimmedInitialContent ? (
            <Fragment set:html={trimmedInitialContent} />
          ) : (
            <p>Aucune information complémentaire pour le moment.</p>
          )
        }
      </div>
    </div>
  </div>
</div>

<script type="module" src={tarifModalClientScript}></script>
