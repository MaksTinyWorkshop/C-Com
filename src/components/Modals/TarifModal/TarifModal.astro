---
import Icon from "@components/Icons/Icon.astro";
import type { IconProps } from "@components/Icons/icon";
import styles from "./tarifModal.module.scss";

interface Props {
  id: string;
  fallbackTitle: string;
  fallbackContent?: string;
  defaultPlan: string;
  initialContent?: string;
  defaultIcon?: IconProps["type"] | null;
  defaultBadge?: string | null;
}

const {
  id,
  fallbackTitle,
  fallbackContent,
  defaultPlan,
  initialContent,
  defaultIcon = null,
  defaultBadge = null,
} = Astro.props as Props;

const replaceScopedClasses = (input?: string | null) => {
  if (!input) return "";
  return input.replace(/\{styles\.([\w-]+)\}/g, (_, token) => {
    const resolved = styles[token as keyof typeof styles];
    return typeof resolved === "string" ? resolved : token;
  });
};

const processedFallbackContent = replaceScopedClasses(fallbackContent);
const processedInitialContent = replaceScopedClasses(initialContent);

const trimmedInitialContent = processedInitialContent.trim()
  ? processedInitialContent
  : "";
const encodedInitialPlanContent = trimmedInitialContent
  ? encodeURIComponent(trimmedInitialContent)
  : "";

const iconEmpty = !defaultIcon && !defaultBadge;
---

<div
  id={id}
  class={styles.modalBackdrop}
  data-tarif-modal-root
  data-open="false"
  aria-hidden="true"
  data-default-plan={defaultPlan}
  data-default-badge={defaultBadge ?? ""}
  data-fallback-title={fallbackTitle}
  data-initial-plan-content={encodedInitialPlanContent}
>
  <div
    class={styles.modal}
    role="dialog"
    aria-modal="true"
    aria-labelledby={`${id}-title`}
    aria-describedby={`${id}-body`}
  >
    <button
      type="button"
      class={styles.modalClose}
      data-modal-close
      aria-label="Fermer la fenêtre d'information"
    >
      ×
    </button>
    <header class={styles.modalHeader}>
      <div class={styles.modalIconGroup}>
        <div
          class={styles.modalIcon}
          data-modal-icon
          data-plan={defaultPlan}
          data-empty={iconEmpty ? "true" : undefined}
          aria-hidden={defaultIcon ? "true" : undefined}
        >
          {
            defaultIcon ? (
              <Icon type={defaultIcon} size={72} aria-hidden="true" />
            ) : defaultBadge ? (
              <span>{defaultBadge}</span>
            ) : (
              <span>{fallbackTitle}</span>
            )
          }
        </div>
      </div>
      <h3 id={`${id}-title`} class={styles.srOnly} data-modal-title>
        {fallbackTitle}
      </h3>
    </header>
    <div class={styles.modalBody}>
      {processedFallbackContent && (
        <div class={styles.modalCommon} data-modal-common>
          <Fragment set:html={processedFallbackContent} />
        </div>
      )}
      <div class={styles.modalPlanContent} data-modal-body>
        {trimmedInitialContent ? (
          <Fragment set:html={trimmedInitialContent} />
        ) : (
          <p>Aucune information complémentaire pour le moment.</p>
        )}
      </div>
    </div>
  </div>
</div>

<script src="./tarifModal.client.ts"></script>
